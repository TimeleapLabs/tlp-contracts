# API Reference

Complete API documentation for the TLPStaking smart contract.

## Table of Contents

- [Read Functions](#read-functions)
- [Write Functions](#write-functions)
- [Events](#events)
- [Errors](#errors)
- [Constants](#constants)

---

## Read Functions

### Provider Queries

#### `getProviderInfo(address provider)`

Returns staking information for a provider.

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| provider | address | Provider address |

**Returns:**
| Name | Type | Description |
|------|------|-------------|
| stakeAmount | uint256 | Amount of TLP staked |
| unlockTime | uint256 | Timestamp when stake unlocks |
| isBanned | bool | Whether provider is banned |
| slashCount | uint256 | Number of times provider has been slashed |

**Example:**
```solidity
(uint256 stake, uint256 unlock, bool banned, uint256 slashes) = staking.getProviderInfo(providerAddress);
```

---

#### `isProviderActive(address provider)`

Checks if a provider can receive rentals.

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| provider | address | Provider address |

**Returns:**
| Type | Description |
|------|-------------|
| bool | True if provider is staked and not banned |

---

### Rental Queries

#### `getRental(bytes32 rentalId)`

Returns rental details.

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| rentalId | bytes32 | Rental ID (generated by backend) |

**Returns:**
| Name | Type | Description |
|------|------|-------------|
| user | address | User who created rental |
| provider | address | Provider serving rental |
| amount | uint256 | Original rental amount |
| timestamp | uint256 | Creation timestamp |
| vm | bytes32 | VM type identifier |
| duration | uint256 | Rental duration in seconds |
| withdrawnAmount | uint256 | Total withdrawn by provider |
| refundedAmount | uint256 | Total refunded to user |

---

#### `getUserRentals(address user)`

Returns all rental IDs for a user.

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| user | address | User address |

**Returns:**
| Type | Description |
|------|-------------|
| bytes32[] | Array of rental IDs |

---

#### `getProviderRentals(address provider)`

Returns all rental IDs received by a provider.

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| provider | address | Provider address |

**Returns:**
| Type | Description |
|------|-------------|
| bytes32[] | Array of rental IDs |

---

### Signer Queries

#### `getSigners()`

Returns all authorized signer addresses.

**Returns:**
| Type | Description |
|------|-------------|
| address[] | Array of signer addresses |

---

#### `getSignerCount()`

Returns number of authorized signers.

**Returns:**
| Type | Description |
|------|-------------|
| uint256 | Number of signers |

---

#### `isSigner(address account)`

Checks if an address is an authorized signer.

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| account | address | Address to check |

**Returns:**
| Type | Description |
|------|-------------|
| bool | True if address is a signer |

---

### Nonce Queries

#### `rentalNonces(address user)`

Returns current rental nonce for a user.

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| user | address | User address |

**Returns:**
| Type | Description |
|------|-------------|
| uint256 | Current nonce |

---

#### `withdrawalNonces(bytes32 rentalId)`

Returns current withdrawal nonce for a rental.

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| rentalId | bytes32 | Rental ID |

**Returns:**
| Type | Description |
|------|-------------|
| uint256 | Current nonce |

---

#### `refundNonces(bytes32 rentalId)`

Returns current refund nonce for a rental.

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| rentalId | bytes32 | Rental ID |

**Returns:**
| Type | Description |
|------|-------------|
| uint256 | Current nonce |

---

### Configuration Queries

#### `vmPricePerSecond(bytes32 vm)`

Returns price per second for a VM type.

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| vm | bytes32 | VM type identifier |

**Returns:**
| Type | Description |
|------|-------------|
| uint256 | Price in TLP per second (0 if not configured) |

---

#### `minStakeDuration()`

Returns minimum staking duration.

**Returns:**
| Type | Description |
|------|-------------|
| uint256 | Duration in seconds (default: 30 days) |

---

#### `rentalGracePeriod()`

Returns the grace period for rentals. Rentals are rejected if `duration + gracePeriod > provider.unlockTime - currentTime`.

**Returns:**
| Type | Description |
|------|-------------|
| uint256 | Grace period in seconds (default: 7 days) |

---

#### `requiredRentalSignatures()`

Returns number of signatures required for rentals.

**Returns:**
| Type | Description |
|------|-------------|
| uint256 | Required signature count |

---

#### `requiredWithdrawalSignatures()`

Returns number of signatures required for withdrawals.

**Returns:**
| Type | Description |
|------|-------------|
| uint256 | Required signature count |

---

#### `requiredRefundSignatures()`

Returns number of signatures required for refunds.

**Returns:**
| Type | Description |
|------|-------------|
| uint256 | Required signature count |

---

#### `domainSeparator()`

Returns EIP712 domain separator.

**Returns:**
| Type | Description |
|------|-------------|
| bytes32 | Domain separator hash |

---

## Write Functions

### Provider Functions

#### `stake(uint256 amount, uint256 duration)`

Stakes TLP tokens to become a provider.

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| amount | uint256 | Amount of TLP to stake |
| duration | uint256 | Lock duration in seconds (>= minStakeDuration) |

**Requirements:**
- `amount > 0`
- `duration >= minStakeDuration`
- Caller must not already be staked
- Caller must not be banned
- Caller must have approved TLP spending

**Emits:** `Staked(provider, amount, unlockTime)`

---

#### `extendStakeDuration(uint256 newUnlockTime)`

Extends stake lock duration.

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| newUnlockTime | uint256 | New unlock timestamp |

**Requirements:**
- Caller must be a provider
- `newUnlockTime >= block.timestamp + minStakeDuration`
- `newUnlockTime > currentUnlockTime`

**Emits:** `StakeExtended(provider, newUnlockTime)`

---

#### `increaseStake(uint256 amount)`

Adds more tokens to existing stake.

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| amount | uint256 | Additional TLP to stake |

**Requirements:**
- `amount > 0`
- Caller must be a provider
- Caller must not be banned

**Emits:** `StakeIncreased(provider, addedAmount, newTotal, newUnlockTime)`

---

#### `withdrawStake()`

Withdraws entire stake after unlock time.

**Requirements:**
- Caller must be a provider
- `block.timestamp >= unlockTime`

**Emits:** `StakeWithdrawn(provider, amount)`

---

### User Functions

#### `rentFromProvider(bytes32 rentalId, address provider, bytes32 vm, uint256 duration, bytes[] signatures)`

Creates a rental from a provider.

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| rentalId | bytes32 | Unique rental ID (generated by backend) |
| provider | address | Provider address |
| vm | bytes32 | VM type identifier |
| duration | uint256 | Rental duration in seconds |
| signatures | bytes[] | EIP712 signatures from authorized signers |

**Requirements:**
- `rentalId != bytes32(0)`
- `provider != address(0)`
- `duration > 0`
- Rental ID must not already exist
- VM price must be configured
- Provider must be active
- Sufficient valid signatures

**Emits:** `RentalCreated(user, provider, rentalId, amount, vm, duration)`

---

#### `claimRefund(bytes32 rentalId, uint256 amount, bytes[] signatures)`

Claims refund for a rental.

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| rentalId | bytes32 | Rental ID |
| amount | uint256 | Refund amount |
| signatures | bytes[] | EIP712 signatures from authorized signers |

**Requirements:**
- Valid rental ID
- Caller is the rental user
- `amount > 0`
- `amount <= available balance`
- Sufficient valid signatures

**Emits:** `RefundClaimed(user, provider, rentalId, amount)`

---

### Provider Withdrawal

#### `withdrawRental(bytes32 rentalId, uint256 amount, bytes[] signatures)`

Provider withdraws rental earnings.

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| rentalId | bytes32 | Rental ID |
| amount | uint256 | Withdrawal amount |
| signatures | bytes[] | EIP712 signatures from authorized signers |

**Requirements:**
- Valid rental ID
- Caller is the rental provider
- `amount > 0`
- `amount <= available balance`
- Sufficient valid signatures

**Emits:** `RentalWithdrawn(provider, rentalId, amount)`

---

#### `batchWithdrawRental(bytes32[] rentalIds, uint256[] amounts, bytes[][] signatures)`

Provider withdraws earnings from multiple rentals in a single transaction. More gas-efficient than multiple individual withdrawals.

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| rentalIds | bytes32[] | Array of rental IDs to withdraw from |
| amounts | uint256[] | Array of withdrawal amounts for each rental |
| signatures | bytes[][] | Array of signature arrays for each withdrawal |

**Requirements:**
- All arrays must have the same length
- For each rental:
  - Valid rental ID
  - Caller is the rental provider
  - `amount > 0`
  - `amount <= available balance`
  - Sufficient valid signatures

**Emits:** `RentalWithdrawn(provider, rentalId, amount)` for each rental

---

### Admin Functions

#### `addSigner(address signer)`

Adds an authorized signer.

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| signer | address | Signer address to add |

**Requirements:**
- Caller has DEFAULT_ADMIN_ROLE
- `signer != address(0)`
- Signer not already authorized

**Emits:** `SignerAdded(signer)`

---

#### `removeSigner(address signer)`

Removes an authorized signer.

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| signer | address | Signer address to remove |

**Requirements:**
- Caller has DEFAULT_ADMIN_ROLE
- Signer is currently authorized

**Emits:** `SignerRemoved(signer)`

**Note:** If required signatures exceed remaining signers, requirements are automatically reduced.

---

#### `setRequiredRentalSignatures(uint256 _required)`

Sets required signatures for rentals.

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| _required | uint256 | Number of required signatures |

**Requirements:**
- Caller has DEFAULT_ADMIN_ROLE
- `_required > 0`
- `_required <= signers.length`

**Emits:** `RequiredRentalSignaturesUpdated(oldRequired, newRequired)`

---

#### `setRequiredWithdrawalSignatures(uint256 _required)`

Sets required signatures for withdrawals.

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| _required | uint256 | Number of required signatures |

**Emits:** `RequiredWithdrawalSignaturesUpdated(oldRequired, newRequired)`

---

#### `setRequiredRefundSignatures(uint256 _required)`

Sets required signatures for refunds.

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| _required | uint256 | Number of required signatures |

**Emits:** `RequiredRefundSignaturesUpdated(oldRequired, newRequired)`

---

#### `setVmPrice(bytes32 vm, uint256 pricePerSecond)`

Sets price for a VM type.

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| vm | bytes32 | VM type identifier |
| pricePerSecond | uint256 | Price per second in TLP (0 to disable) |

**Emits:** `VmPriceUpdated(vm, oldPrice, newPrice)`

---

#### `setMinStakeDuration(uint256 newDuration)`

Sets minimum stake duration.

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| newDuration | uint256 | New duration in seconds |

**Emits:** `MinStakeDurationUpdated(oldDuration, newDuration)`

---

#### `setRentalGracePeriod(uint256 newPeriod)`

Sets grace period for rentals. Rentals are rejected if the rental duration plus grace period exceeds the provider's remaining stake time.

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| newPeriod | uint256 | New grace period in seconds |

**Requirements:**
- Caller has DEFAULT_ADMIN_ROLE

**Emits:** `RentalGracePeriodUpdated(oldPeriod, newPeriod)`

---

#### `setTreasury(address newTreasury)`

Sets treasury address for slashed funds.

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| newTreasury | address | New treasury address |

**Emits:** `TreasuryUpdated(oldTreasury, newTreasury)`

---

### Police Functions

#### `slashAndBan(address provider)`

Slashes all stake and bans provider.

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| provider | address | Provider to slash |

**Requirements:**
- Caller has POLICE_ROLE
- Provider has stake (`stakeAmount > 0`)
- Provider is not already banned

**Emits:** `ProviderSlashed(provider, slashedAmount, true)`

---

#### `slashPartial(address provider, uint256 slashAmount)`

Slashes partial stake without banning.

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| provider | address | Provider to slash |
| slashAmount | uint256 | Amount to slash |

**Requirements:**
- Caller has POLICE_ROLE
- Provider is staked
- `slashAmount > 0`
- `slashAmount <= stakeAmount`

**Emits:** `ProviderSlashed(provider, slashAmount, false)`

---

#### `unbanProvider(address provider)`

Unbans a previously banned provider.

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| provider | address | Provider to unban |

**Requirements:**
- Caller has DEFAULT_ADMIN_ROLE
- Provider is currently banned

**Emits:** `ProviderUnbanned(provider)`

---

## Events

| Event | Parameters | Description |
|-------|------------|-------------|
| `Staked` | provider, amount, unlockTime | Provider staked tokens |
| `StakeExtended` | provider, newUnlockTime | Stake duration extended |
| `StakeIncreased` | provider, addedAmount, newTotal, newUnlockTime | Additional tokens staked |
| `StakeWithdrawn` | provider, amount | Provider withdrew stake |
| `RentalCreated` | user, provider, rentalId, amount, vm, duration | New rental created |
| `RentalWithdrawn` | provider, rentalId, amount | Provider withdrew earnings |
| `RefundClaimed` | user, provider, rentalId, amount | User claimed refund |
| `ProviderSlashed` | provider, slashedStake, banned | Provider was slashed |
| `ProviderUnbanned` | provider | Provider was unbanned |
| `SignerAdded` | signer | New signer authorized |
| `SignerRemoved` | signer | Signer removed |
| `RequiredRentalSignaturesUpdated` | oldRequired, newRequired | Rental signatures changed |
| `RequiredWithdrawalSignaturesUpdated` | oldRequired, newRequired | Withdrawal signatures changed |
| `RequiredRefundSignaturesUpdated` | oldRequired, newRequired | Refund signatures changed |
| `VmPriceUpdated` | vm, oldPrice, newPrice | VM price changed |
| `MinStakeDurationUpdated` | oldDuration, newDuration | Min duration changed |
| `RentalGracePeriodUpdated` | oldPeriod, newPeriod | Rental grace period changed |
| `TreasuryUpdated` | oldTreasury, newTreasury | Treasury address changed |

---

## Errors

| Error | Description |
|-------|-------------|
| `ZeroAddress()` | Address parameter is zero |
| `ZeroAmount()` | Amount parameter is zero |
| `InsufficientStake()` | Not enough stake |
| `StakeLocked()` | Stake still locked |
| `AlreadyStaked()` | Provider already has an active stake |
| `ProviderBanned()` | Provider is banned |
| `ProviderNotBanned()` | Provider not banned (for unban) |
| `NotAProvider()` | Address is not a provider |
| `InvalidDuration()` | Invalid duration parameter |
| `DurationTooShort()` | Duration below minimum |
| `RentalNotFound()` | Invalid rental ID or wrong caller |
| `RentalAlreadyExists()` | Rental ID already used |
| `RentalExceedsStakeDuration()` | Rental duration + grace period exceeds provider stake time |
| `AmountExceedsAvailable()` | Amount exceeds available balance |
| `NothingToWithdraw()` | No amount available |
| `InvalidSlashAmount()` | Invalid slash amount |
| `VmNotConfigured()` | VM type not priced |
| `SignerAlreadyAuthorized()` | Signer already added |
| `SignerNotAuthorized()` | Signer not found |
| `InsufficientSignatures()` | Not enough valid signatures |
| `DuplicateSignature()` | Same signer used twice |
| `InvalidSignature()` | Signature from non-signer |
| `InvalidRequiredSignatures()` | Invalid signature requirement |
| `ArrayLengthMismatch()` | Arrays have different lengths in batch operations |

---

## Constants

| Constant | Value | Description |
|----------|-------|-------------|
| `POLICE_ROLE` | `keccak256("POLICE_ROLE")` | Role for slashing |
| `DEFAULT_ADMIN_ROLE` | `0x00...00` | Admin role |
| `minStakeDuration` | 30 days (default) | Minimum stake lock |
| `rentalGracePeriod` | 7 days (default) | Grace period for rental duration check |
