# TypeScript Client Library

Complete guide for using the TLPStaking TypeScript client library.

## Installation

The client library is included in the `src/client/` directory. Import it directly:

```typescript
import {
  TLPStakingClient,
  TLPStakingSigner,
  encodeVmId,
  decodeVmId,
} from "./src/client";
```

## Quick Start

```typescript
import { ethers } from "ethers";
import { TLPStakingClient, TLPStakingSigner } from "./src/client";

// Connect to provider
const provider = new ethers.JsonRpcProvider("https://rpc.example.com");
const wallet = new ethers.Wallet(privateKey, provider);

// Create client
const client = new TLPStakingClient(provider, contractAddress);

// Read data
const rentalId = "0x0123456789abcdef..."; // bytes32 from backend
const rental = await client.getRental(rentalId);
console.log(`Rental amount: ${ethers.formatEther(rental.amount)} TLP`);

// Create signer for EIP712 signatures
const signer = await client.createSigner(wallet);
```

## TLPStakingClient

The main client for interacting with the TLPStaking contract.

### Constructor

```typescript
const client = new TLPStakingClient(
  providerOrSigner,  // ethers Provider or Signer
  contractAddress    // Contract address string
);
```

### Read Methods

#### Provider Queries

```typescript
// Get provider info
const info = await client.getProviderInfo(providerAddress);
console.log(`Stake: ${info.stakeAmount}`);
console.log(`Unlock: ${new Date(Number(info.unlockTime) * 1000)}`);
console.log(`Banned: ${info.isBanned}`);
console.log(`Slash count: ${info.slashCount}`);

// Check if provider is active
const isActive = await client.isProviderActive(providerAddress);
```

#### Rental Queries

```typescript
// Get rental details (rentalId is a bytes32 string from backend)
const rental = await client.getRental(rentalId);
console.log(`User: ${rental.user}`);
console.log(`Provider: ${rental.provider}`);
console.log(`Amount: ${rental.amount}`);
console.log(`VM: ${decodeVmId(rental.vm)}`);
console.log(`Duration: ${rental.duration} seconds`);
console.log(`Withdrawn: ${rental.withdrawnAmount}`);
console.log(`Refunded: ${rental.refundedAmount}`);

// Get user's rentals (returns bytes32[] of rental IDs)
const userRentals = await client.getUserRentals(userAddress);

// Get provider's received rentals
const providerRentals = await client.getProviderRentals(providerAddress);
```

#### Signer Queries

```typescript
// Get all signers
const signers = await client.getSigners();

// Get signer count
const count = await client.getSignerCount();

// Check if address is signer
const isSigner = await client.isSigner(address);

// Get required signatures
const rentalSigs = await client.getRequiredRentalSignatures();
const withdrawalSigs = await client.getRequiredWithdrawalSignatures();
const refundSigs = await client.getRequiredRefundSignatures();
```

#### Nonce Queries

```typescript
// Get rental nonce for a user
const rentalNonce = await client.getRentalNonce(userAddress);

// Get withdrawal nonce for a rental
const withdrawalNonce = await client.getWithdrawalNonce(rentalId);

// Get refund nonce for a rental
const refundNonce = await client.getRefundNonce(rentalId);
```

#### Configuration Queries

```typescript
// Get VM price
const price = await client.getVmPrice(vmId);

// Calculate rental cost
const cost = await client.calculateRentalAmount(vmId, duration);

// Get min stake duration
const minDuration = await client.getMinStakeDuration();

// Get rental grace period
const gracePeriod = await client.getRentalGracePeriod();

// Get treasury address
const treasury = await client.getTreasury();

// Get TLP token address
const token = await client.getTlpToken();

// Get EIP712 domain separator
const domainSeparator = await client.getDomainSeparator();
```

### Write Methods

#### Provider Operations

```typescript
// Stake tokens (requires signer)
const clientWithSigner = client.connect(wallet);

// Stake 10,000 TLP for 30 days
const tx1 = await clientWithSigner.stake(
  ethers.parseEther("10000"),
  30n * 24n * 60n * 60n  // 30 days in seconds
);
await tx1.wait();

// Extend stake duration
const newUnlockTime = BigInt(Math.floor(Date.now() / 1000)) + 60n * 24n * 60n * 60n;
const tx2 = await clientWithSigner.extendStakeDuration(newUnlockTime);

// Increase stake
const tx3 = await clientWithSigner.increaseStake(ethers.parseEther("5000"));

// Withdraw stake (after unlock)
const tx4 = await clientWithSigner.withdrawStake();
```

#### User Operations

```typescript
// Rent from provider (requires signatures)
// rentalId is a bytes32 generated by the backend
const rentalId = "0x0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef";
const tx = await clientWithSigner.rentFromProvider(
  rentalId,
  providerAddress,
  vmId,
  3600n,  // 1 hour
  signatures
);
const receipt = await tx.wait();

// Claim refund (requires signatures)
const refundTx = await clientWithSigner.claimRefund(
  rentalId,
  refundAmount,
  signatures
);
```

#### Provider Withdrawal

```typescript
// Withdraw rental earnings (requires signatures)
const withdrawTx = await clientWithSigner.withdrawRental(
  rentalId,
  withdrawAmount,
  signatures
);

// Batch withdraw from multiple rentals (more gas efficient)
const batchWithdrawTx = await clientWithSigner.batchWithdrawRental(
  [rentalId1, rentalId2, rentalId3],
  [amount1, amount2, amount3],
  [signatures1, signatures2, signatures3]
);
```

#### Admin Operations

```typescript
// Add signer (admin only)
await clientWithSigner.addSigner(signerAddress);

// Remove signer
await clientWithSigner.removeSigner(signerAddress);

// Set required signatures
await clientWithSigner.setRequiredRentalSignatures(1n);
await clientWithSigner.setRequiredWithdrawalSignatures(2n);
await clientWithSigner.setRequiredRefundSignatures(2n);

// Set VM price
const vmId = encodeVmId("vm.small");
await clientWithSigner.setVmPrice(vmId, ethers.parseEther("0.001"));

// Set min stake duration
await clientWithSigner.setMinStakeDuration(45n * 24n * 60n * 60n);

// Set rental grace period
await clientWithSigner.setRentalGracePeriod(14n * 24n * 60n * 60n); // 14 days

// Set treasury
await clientWithSigner.setTreasury(newTreasuryAddress);
```

#### Police Operations

```typescript
// Slash and ban (police only)
await clientWithSigner.slashAndBan(providerAddress);

// Partial slash
await clientWithSigner.slashPartial(providerAddress, slashAmount);

// Unban (admin only)
await clientWithSigner.unbanProvider(providerAddress);
```

## TLPStakingSigner

Helper class for creating EIP712 signatures.

### Constructor

```typescript
// Create directly
const signer = new TLPStakingSigner(
  ethersWallet,      // Ethers Signer
  contractAddress,   // Contract address
  chainId           // Chain ID as bigint
);

// Or from client
const signer = await client.createSigner(ethersWallet);

// Or using static method
const signer = await TLPStakingSigner.fromSigner(ethersWallet, contractAddress);
```

### Sign Rental Approval

```typescript
const signature = await signer.signRentalApproval({
  rentalId: "0x0123456789abcdef...",  // bytes32 from backend
  user: userAddress,
  provider: providerAddress,
  vm: vmId,
  duration: 3600n,
  nonce: 0n,
});
```

### Sign Withdrawal Approval

```typescript
const signature = await signer.signWithdrawalApproval({
  rentalId: "0x0123456789abcdef...",  // bytes32
  provider: providerAddress,
  amount: ethers.parseEther("1.5"),
  nonce: 0n,
});
```

### Sign Refund Approval

```typescript
const signature = await signer.signRefundApproval({
  rentalId: "0x0123456789abcdef...",  // bytes32
  user: userAddress,
  amount: ethers.parseEther("0.5"),
  nonce: 0n,
});
```

### Collect Multiple Signatures

```typescript
// Collect signatures from multiple signers
const signers = [signer1, signer2, signer3];

const signatures = await TLPStakingSigner.collectSignatures(
  signers,
  (s) => s.signRentalApproval({
    rentalId: "0x0123456789abcdef...",  // bytes32 from backend
    user: userAddress,
    provider: providerAddress,
    vm: vmId,
    duration: 3600n,
    nonce: 0n,
  })
);
```

## Utility Functions

### VM ID Encoding

```typescript
import { encodeVmId, decodeVmId } from "./src/client";

// Encode VM name to bytes32
const vmId = encodeVmId("vm.small");

// Decode bytes32 to VM name
const vmName = decodeVmId(vmId);
```

### Duration Formatting

```typescript
import { formatDuration } from "./src/client";

// Format seconds to human-readable
console.log(formatDuration(3600));     // "1 hour"
console.log(formatDuration(86400));    // "1 day"
console.log(formatDuration(90061));    // "1 day 1 hour 1 minute 1 second"
```

### Time Calculations

```typescript
import {
  calculateUnlockTime,
  isStakeLocked,
  timeUntilUnlock,
  secondsToDays,
  daysToSeconds,
} from "./src/client";

// Calculate unlock time from duration
const unlockTime = calculateUnlockTime(30 * 24 * 60 * 60);  // 30 days from now

// Check if stake is locked
const isLocked = isStakeLocked(unlockTime);

// Get remaining time
const remaining = timeUntilUnlock(unlockTime);

// Convert between days and seconds
const days = secondsToDays(2592000n);  // 30
const seconds = daysToSeconds(30);      // 2592000n
```

### Amount Calculation

```typescript
import { calculateRentalAmount } from "./src/client";

// Calculate rental cost
const cost = calculateRentalAmount(
  ethers.parseEther("0.001"),  // price per second
  3600n                        // duration
);
// Result: 3.6 TLP
```

## Type Definitions

### Rental

```typescript
interface Rental {
  user: string;
  provider: string;
  amount: bigint;
  timestamp: bigint;
  vm: string;
  duration: bigint;
  withdrawnAmount: bigint;
  refundedAmount: bigint;
}
```

### ProviderInfo

```typescript
interface ProviderInfo {
  stakeAmount: bigint;
  unlockTime: bigint;
  isBanned: boolean;
  slashCount: bigint;
}
```

### Approval Data Types

```typescript
interface RentalApprovalData {
  rentalId: string;   // bytes32 from backend
  user: string;
  provider: string;
  vm: string;
  duration: bigint;
  nonce: bigint;
}

interface WithdrawalApprovalData {
  rentalId: string;   // bytes32
  provider: string;
  amount: bigint;
  nonce: bigint;
}

interface RefundApprovalData {
  rentalId: string;   // bytes32
  user: string;
  amount: bigint;
  nonce: bigint;
}
```

## Complete Examples

### Provider Registration Flow

```typescript
import { ethers } from "ethers";
import { TLPStakingClient } from "./src/client";

async function registerProvider() {
  const provider = new ethers.JsonRpcProvider(RPC_URL);
  const wallet = new ethers.Wallet(PROVIDER_KEY, provider);
  
  const client = new TLPStakingClient(provider, CONTRACT_ADDRESS);
  const clientWithSigner = client.connect(wallet);
  
  // First approve TLP spending
  const tlpToken = new ethers.Contract(TLP_ADDRESS, ERC20_ABI, wallet);
  const stakeAmount = ethers.parseEther("10000");
  await tlpToken.approve(CONTRACT_ADDRESS, stakeAmount);
  
  // Then stake
  const stakeDuration = 30n * 24n * 60n * 60n; // 30 days
  const tx = await clientWithSigner.stake(stakeAmount, stakeDuration);
  await tx.wait();
  
  console.log("Provider registered successfully!");
}
```

### Backend Signing Service

```typescript
import { ethers } from "ethers";
import { TLPStakingSigner } from "./src/client";

class SigningService {
  private signers: TLPStakingSigner[];

  constructor(
    wallets: ethers.Wallet[],
    contractAddress: string,
    chainId: bigint
  ) {
    this.signers = wallets.map(
      w => new TLPStakingSigner(w, contractAddress, chainId)
    );
  }

  async signRental(
    rentalId: string,  // bytes32 generated by backend
    user: string,
    provider: string,
    vm: string,
    duration: bigint,
    nonce: bigint
  ): Promise<string[]> {
    return TLPStakingSigner.collectSignatures(
      this.signers,
      (s) => s.signRentalApproval({ rentalId, user, provider, vm, duration, nonce })
    );
  }

  async signWithdrawal(
    rentalId: string,  // bytes32
    provider: string,
    amount: bigint,
    nonce: bigint
  ): Promise<string[]> {
    return TLPStakingSigner.collectSignatures(
      this.signers,
      (s) => s.signWithdrawalApproval({ rentalId, provider, amount, nonce })
    );
  }

  async signRefund(
    rentalId: string,  // bytes32
    user: string,
    amount: bigint,
    nonce: bigint
  ): Promise<string[]> {
    return TLPStakingSigner.collectSignatures(
      this.signers,
      (s) => s.signRefundApproval({ rentalId, user, amount, nonce })
    );
  }
}
```

### User Rental Flow

```typescript
import { ethers } from "ethers";
import { TLPStakingClient, encodeVmId } from "./src/client";

async function rentVM(
  userWallet: ethers.Wallet,
  providerAddress: string,
  vmType: string,
  durationSeconds: bigint,
  rentalId: string,    // bytes32 from backend
  signatures: string[]
) {
  const client = new TLPStakingClient(userWallet.provider!, CONTRACT_ADDRESS);
  const clientWithSigner = client.connect(userWallet);

  // Calculate cost and approve
  const vmId = encodeVmId(vmType);
  const cost = await client.calculateRentalAmount(vmId, durationSeconds);

  const tlpToken = new ethers.Contract(TLP_ADDRESS, ERC20_ABI, userWallet);
  await tlpToken.approve(CONTRACT_ADDRESS, cost);

  // Create rental with backend-provided rentalId
  const tx = await clientWithSigner.rentFromProvider(
    rentalId,
    providerAddress,
    vmId,
    durationSeconds,
    signatures
  );
  await tx.wait();

  return rentalId;
}
```
